custom_rules:
  - workflow/snakemake_rules/download_from_s3.smk
  - profiles/nextflu-private/antigenic_distances.smk
  - profiles/nextflu-private/report.smk

fasta_fields:
  - strain
  - virus
  - segment
  - accession
  - date
  - date_submitted
  - region
  - country
  - division
  - location
  - passage_category
  - originating_lab
  - submitting_lab
  - age
  - gender
prettify_fields:
  - region
  - country
  - division
  - location
  - originating_lab
  - submitting_lab

lat-longs: "config/lat_longs.tsv"

segments:
  - ha

tree:
  method: iqtree
  tree-builder-args: "'-ninit 10 -n 4 -czb -nt AUTO'"
  override_default_args: true

submission_date_field: date_submitted
recency:
  date_bins: [7, 30, 90]
  date_bin_labels: ["last week", "last month", "last quarter"]
  upper_bin_label: older

builds:
  h1n1pdm_2y_human_titers:
    lineage: h1n1pdm
    reference: "config/h1n1pdm/{segment}/reference.fasta"
    annotation: "config/h1n1pdm/{segment}/genemap.gff"
    tree_exclude_sites: "config/h1n1pdm/{segment}/exclude-sites.txt"
    clades: "config/h1n1pdm/ha/clades.tsv"
    subclades: "config/h1n1pdm/{segment}/subclades.tsv"
    auspice_config: "profiles/nextflu-private/h1n1pdm/{segment}/auspice_config.json"
    min_date: "2Y"
    reference_min_date: "6Y"
    max_date: "4W"
    include: "config/h1n1pdm/reference_strains.txt"
    exclude: "config/h1n1pdm/outliers.txt"
    vaccines: "config/h1n1pdm/vaccine.json"
    enable_glycosylation: true
    enable_lbi: true
    enable_titer_models: true
    enable_measurements: true
    titer_collections:
      - name: individual_human_cell_hi
        data: "data/h1n1pdm/h1n1pdm_vidrl_individual-human_cell_hi_titers.tsv"
        prefix: individual_human_cell_hi_
        title: "Cell-passaged HI titers from individual human sera"
      - name: individual_human_egg_hi
        data: "data/h1n1pdm/h1n1pdm_vidrl_individual-human_egg_hi_titers.tsv"
        prefix: individual_human_egg_hi_
        title: "Egg-passaged HI titers from individual human sera"
    subsamples: &titers-subsampling-scheme
      regions_except_europe:
          filters: --query "(passage_category != 'egg') & (region != 'Europe')" --group-by region year month --subsample-max-sequences 180 --min-date {min_date} --exclude {exclude}
          priorities: "titers"
      europe:
          filters: --query "(passage_category != 'egg') & (region == 'Europe')" --group-by country year month --subsample-max-sequences 20 --min-date {min_date} --exclude {exclude}
          priorities: "titers"
      references:
          filters: --query "(is_reference == True)" --min-date {reference_min_date} --exclude {exclude}
      titer_strains:
          # We allow egg-passage strains when they have titer measurements,
          # enabling titer models to be fit to egg-passaged data.
          filters: --query "(is_titer_strain == True)" --min-date {min_date} --exclude {exclude}
  # h3n2_2y_titers:
  #   lineage: "h3n2"
  #   reference: "config/h3n2/{segment}/reference.fasta"
  #   annotation: "config/h3n2/{segment}/genemap.gff"
  #   tree_exclude_sites: "config/h3n2/{segment}/exclude-sites.txt"
  #   clades: "config/h3n2/ha/clades.tsv"
  #   subclades: "config/h3n2/{segment}/subclades.tsv"
  #   auspice_config: "profiles/nextflu-private/h3n2/{segment}/auspice_config.json"
  #   vaccines: "config/h3n2/vaccine.json"
  #   enable_glycosylation: true
  #   enable_lbi: true
  #   enable_titer_models: true
  #   enable_measurements: true
  #   min_date: "2Y"
  #   reference_min_date: "6Y"
  #   max_date: "4W"
  #   include: "config/h3n2/reference_strains.txt"
  #   exclude: "config/h3n2/outliers.txt"
  #   titer_collections:
  #     - name: individual_human_cell_hi
  #       data: "data/h3n2/h3n2_vidrl_individual-human_cell_hi_titers.tsv"
  #       prefix: individual_human_cell_hi_
  #       title: "Cell-passaged HI titers from individual human sera"
  #     - name: individual_human_egg_hi
  #       data: "data/h3n2/h3n2_vidrl_individual-human_egg_hi_titers.tsv"
  #       prefix: individual_human_egg_hi_
  #       title: "Egg-passaged HI titers from individual human sera"
  #     - name: individual_human_cell_fra
  #       data: "data/h3n2/h3n2_vidrl_individual-human_cell_fra_titers.tsv"
  #       prefix: individual_human_cell_fra_
  #       title: "Cell-passaged FRA titers from individual human sera"
  #     - name: individual_human_egg_fra
  #       data: "data/h3n2/h3n2_vidrl_individual-human_egg_fra_titers.tsv"
  #       prefix: individual_human_egg_fra_
  #       title: "Egg-passaged FRA titers from individual human sera"
  #   subsamples: *titers-subsampling-scheme
  # vic_2y_titers:
  #   lineage: vic
  #   reference: "config/vic/{segment}/reference.fasta"
  #   annotation: "config/vic/{segment}/genemap.gff"
  #   tree_exclude_sites: "config/vic/{segment}/exclude-sites.txt"
  #   clades: "profiles/nextflu-private/vic/ha/clades.tsv"
  #   subclades: "config/vic/{segment}/subclades.tsv"
  #   auspice_config: "profiles/nextflu-private/vic/{segment}/auspice_config.json"
  #   min_date: "2Y"
  #   reference_min_date: "6Y"
  #   max_date: "4W"
  #   include: "config/vic/reference_strains.txt"
  #   exclude: "config/vic/outliers.txt"
  #   vaccines: "config/vic/vaccine.json"
  #   enable_glycosylation: true
  #   enable_lbi: true
  #   enable_titer_models: true
  #   enable_measurements: true
  #   titer_collections:
  #     - name: individual_human_cell_hi
  #       data: "data/vic/vic_vidrl_individual-human_cell_hi_titers.tsv"
  #       prefix: individual_human_cell_hi_
  #       title: "Cell-passaged HI titers from individual human sera"
  #     - name: individual_human_egg_hi
  #       data: "data/vic/vic_vidrl_individual-human_egg_hi_titers.tsv"
  #       prefix: individual_human_egg_hi_
  #       title: "Egg-passaged HI titers from individual human sera"
  #   subsamples: *titers-subsampling-scheme
