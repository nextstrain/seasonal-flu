# Define the earliest date to select all available sequences per subtype. This
# date corresponds to the reporting period of the upcoming vaccine composition
# meeting. For the VCM in September, we tend to report on data from February of
# that year.
min_date: &min_date 2025-02-01

custom_rules:
  - workflow/snakemake_rules/download_from_s3.smk

lat-longs: "config/lat_longs.tsv"

segments:
  - ha
  - na

tree:
  tree-builder-args: "'--pathogen-force -ninit 2 -n 2 --epsilon 0.05 -czb -T AUTO --redo'"
  override_default_args: true

refine:
  # Disable the clock filter.
  clock_filter_iqd: 0

submission_date_field: date_submitted
recency:
  date_bins: [7, 30, 90]
  date_bin_labels: ["last week", "last month", "last quarter"]
  upper_bin_label: older

builds:
    full-h3n2:
      lineage: h3n2
      reference: "config/h3n2/{segment}/reference.fasta"
      annotation: "config/h3n2/{segment}/genemap.gff"
      tree_exclude_sites: "config/h3n2/{segment}/exclude-sites.txt"
      clades: "config/h3n2/ha/clades.tsv"
      subclades: "config/h3n2/{segment}/subclades.tsv"
      emerging_haplotypes: "config/h3n2/{segment}/emerging_haplotypes.tsv"
      auspice_config: "profiles/nextflu-private/h3n2/{segment}/auspice_config.json"
      vaccines: "config/h3n2/vaccine.json"
      enable_glycosylation: true
      enable_titer_models: true
      enable_measurements: true
      min_date: *min_date
      reference_min_date: "6Y"
      subsamples: &subsampling
        all_good_sequences:
            filters: --min-date {min_date} --query "\`qc.overallStatus\` == 'good'" --exclude-ambiguous-dates-by any --exclude-where 'ha!=True' 'na!=True' --exclude config/{lineage}/outliers.txt
        titer_reference_strains:
          # We allow egg-passage strains when they have titer measurements,
          # enabling titer models to be fit to egg-passaged data.
          filters: --query "(is_titer_reference_strain == True)" --min-date {reference_min_date} --exclude config/{lineage}/outliers.txt
      titer_collections:
        - name: cell_fra
          data: "data/h3n2/who_ferret_cell_fra_titers.tsv"
          prefix: cell_fra_
          title: "Cell-passaged FRA titers from ferret sera"
        - name: cell_hi
          data: "data/h3n2/who_ferret_cell_hi_titers.tsv"
          prefix: cell_hi_
          title: "Cell-passaged HI titers from ferret sera"
        - name: egg_hi
          data: "data/h3n2/who_ferret_egg_hi_titers.tsv"
          prefix: egg_hi_
          title: "Egg-passaged HI titers from ferret sera"
      frequencies: &frequencies
        narrow_bandwidth: 0.02
        pivot_interval: 1
        pivot_interval_units: weeks
    full-h1n1pdm:
      lineage: h1n1pdm
      reference: "config/h1n1pdm/{segment}/reference.fasta"
      annotation: "config/h1n1pdm/{segment}/genemap.gff"
      tree_exclude_sites: "config/h1n1pdm/{segment}/exclude-sites.txt"
      clades: "config/h1n1pdm/ha/clades.tsv"
      subclades: "config/h1n1pdm/{segment}/subclades.tsv"
      emerging_haplotypes: "config/h1n1pdm/{segment}/emerging_haplotypes.tsv"
      auspice_config: "profiles/nextflu-private/h1n1pdm/{segment}/auspice_config.json"
      vaccines: "config/h1n1pdm/vaccine.json"
      enable_glycosylation: true
      enable_titer_models: true
      enable_measurements: true
      min_date: *min_date
      reference_min_date: "6Y"
      subsamples: *subsampling
      titer_collections:
        - name: cell_hi
          data: "data/h1n1pdm/who_ferret_cell_hi_titers.tsv"
          prefix: cell_hi_
          title: "Cell-passaged HI titers from ferret sera"
        - name: egg_hi
          data: "data/h1n1pdm/who_ferret_egg_hi_titers.tsv"
          prefix: egg_hi_
          title: "Egg-passaged HI titers from ferret sera"
      frequencies: *frequencies
    full-vic:
      lineage: vic
      reference: "config/vic/{segment}/reference.fasta"
      annotation: "config/vic/{segment}/genemap.gff"
      tree_exclude_sites: "config/vic/{segment}/exclude-sites.txt"
      clades: "config/vic/ha/clades.tsv"
      subclades: "config/vic/{segment}/subclades.tsv"
      emerging_haplotypes: "config/vic/{segment}/emerging_haplotypes.tsv"
      auspice_config: "profiles/nextflu-private/vic/{segment}/auspice_config.json"
      vaccines: "config/vic/vaccine.json"
      enable_glycosylation: true
      enable_titer_models: true
      enable_measurements: true
      min_date: *min_date
      reference_min_date: "6Y"
      subsamples: *subsampling
      titer_collections:
        - name: cell_hi
          data: "data/vic/who_ferret_cell_hi_titers.tsv"
          prefix: cell_hi_
          title: "Cell-passaged HI titers from ferret sera"
        - name: egg_hi
          data: "data/vic/who_ferret_egg_hi_titers.tsv"
          prefix: egg_hi_
          title: "Egg-passaged HI titers from ferret sera"
      frequencies: *frequencies
