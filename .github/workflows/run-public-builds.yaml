name: Run the Nextstrain public builds

on:
  workflow_dispatch:
    inputs:
      dockerImage:
        description: "Specific container image to use for build (will override the default of `nextstrain build`)"
        required: false
        type: string
      trial_name:
        description: |
          Trial name for deploying builds.
          If not set, builds will overwrite existing builds at s3://nextstrain-data/seasonal_flu*
          If set, builds will be deployed to s3://nextstrain-staging/seasonal-flu_trials_<trial_name>_*
        required: false
        type: string
      sequences_url:
        description: "S3 URL for sequences.fasta.xz, must contain the {lineage} and {segment} wildcards."
        required: false
        type: string
      metadata_url:
        description: "S3 URL for metadata.tsv.xz, must contain the {lineage} wildcard."
        required: false
        type: string

jobs:
  run-build:
    permissions:
      id-token: write
    uses: nextstrain/.github/.github/workflows/pathogen-repo-build.yaml@master
    secrets: inherit
    with:
      runtime: aws-batch
      env: |
        NEXTSTRAIN_DOCKER_IMAGE: ${{ inputs.dockerImage }}
        TRIAL_NAME: ${{ inputs.trial_name }}
        METADATA_URL: ${{ inputs.metadata_url }}
        SEQUENCES_URL: ${{ inputs.sequences_url }}
      run: |
        declare -a config

        if [[ "$TRIAL_NAME" ]]; then
          config+=("deploy_url=s3://nextstrain-staging/seasonal-flu_trials_${TRIAL_NAME}_")
        fi

        if [[ "$METADATA_URL" ]]; then
          config+=("metadata_url=${METADATA_URL}")
        fi

        if [[ "$SEQUENCES_URL" ]]; then
          config+=("sequences_url=${SEQUENCES_URL}")
        fi

        nextstrain build \
          --detach \
          --cpus 36 \
          --memory 72gib \
          . \
          deploy_all \
          -p \
          --configfile profiles/nextstrain-public.yaml \
          --config "${config[@]}"
